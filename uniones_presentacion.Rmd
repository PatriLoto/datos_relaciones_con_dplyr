---
title: "Datos Relacionales"
subtitle: "con dplyr"
author: "Patricia A. Loto (@patriloto)"
date: '13/04/2020'
output:
  xaringan::moon_reader:
    css: "summer_light.css"
    #css-fonts: "summer-fonts"
    #css: [default, summer_light, summer-fonts ]
    # lib_dir: libs
    nature:
      ratio: "16:12"
      autoplay: 40000  
      highlightStyle: atelier-lakeside-light
      highlightLines: true
      countIncrementalSlides: true
      
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(warning = FALSE, message = FALSE, 
                      fig.width = 10.5, fig.height = 4, 
                      comment = NA, rows.print = 10)
options(htmltools.dir.version = FALSE)
options(servr.daemon = TRUE)
#xaringan:::list_css()
```

# 驴Qu茅 vamos a aprender?

 1. Tipos de claves: primaria, for谩nea y subrogada
 
 1. 驴Qu茅 es una relaci贸n? 
 
 1. Uniones de transformaci贸n
 
 1. Uniones de filtrado
 
 1. Operaciones con conjuntos
---

class: inverse, center,bottom
background-image: url("largada.jpg")
background-size:cover
## 隆Empecemos!

---
class: inverse, center, middle

## Motivaci贸n
#### En la vida real es raro que un an谩lisis de datos involucre una 煤nica tabla de datos, por el contrario necesitaremos trabajar con m谩s de un dataset, por lo que ser谩 de suma utilidad aprender a unir dos o m谩s tablas. Para esto, aprenderemos los conjuntos de verbos que facilitan las **uniones** o  **JOINS**.

---
class: inverse, center, top
color-text:black
background-image: url("vuelos.jpg")
background-size:cover
## Dataset

#### Usaremos los datos sobre vuelos desde y hacia la ciudad de Nueva York, incluidos en el paquete **datos**, para aprender sobre datos relacionales. El paquete **datos** contiene cuatro tablas que se relacionan con la tabla `vuelos`:

```{r echo=FALSE, message=FALSE, warning=FALSE, tidy=FALSE}
library(tidyverse)
library(datos)
library(nycflights13)
library(here)
library(dplyr)
library(DT)
#library(aicon)
```

---
class: inverse, center, top
background-image: url("aeropuertos.jpg")
background-size:cover
### Aeropuertos

### Contiene informaci贸n de cada aeropuerto, identificado por su c贸digo.

---
# aeropuertos

```{r aeropuerto, echo=FALSE}
#knitr::kable(head(aeropuertos), format = 'html')
glimpse(aeropuertos)
```

---
class: inverse, center, top
background-image: url("aerolineas.jpg")
background-size:cover
## Aerol铆neas

---
# aerolineas

#### Permite observar el nombre completo de la aerol铆nea a partir de su c贸digo abreviado.

```{r aerolineas, echo=FALSE, message=FALSE, warning=FALSE}
#knitr::kable(head(aerolineas), format = 'html')
#datatable(aerolineas)
glimpse(aerolineas)
```

---
class: inverse, left, top
background-image: url("aviones.jpg")
background-size:cover
# Aviones

### Entrega informaci贸n de cada avi贸n, identificado por su codigo_cola.

---
# aviones

```{r aviones, echo=FALSE, message=FALSE, warning=FALSE}
#knitr::kable(head(aviones), format = 'html')
#aviones
#datatable(aviones)
glimpse(aviones)
```

---
class: inverse, center, bottom
background-image: url("clima.jpg")
background-size:cover
# Clima

### Entrega informaci贸n del clima en cada aeropuerto de Nueva York para cada hora.

---
# clima

```{r clima, echo=FALSE}
#knitr::kable(head(clima), format = 'html')
glimpse(clima)
```

---
# Relaciones

* Recordemos que, se llaman **datos relacionales** a m煤ltiples tablas de datos, ya que no solo importan los conjuntos de datos individuales, sino que tambi茅n sus relaciones son importantes.


--
* Una **clave primaria** y su correspondiente **clave for谩nea** en otra tabla forman una relaci贸n. 

--
* Las **relaciones** siempre se definen sobre un par de tablas. Todas las otras relaciones se construyen sobre esta idea simple: las relaciones entre tres o m谩s tablas son siempre una propiedad de las relaciones entre cada par. 

---
# Relaciones

Diagrama de relaciones entre las diferentes tablas del dataset **vuelos**:
```{r diagrama_vuelos, echo=FALSE, out.width = '60%', fig.align="center"}

knitr::include_graphics("relational-nycflights.svg")
#<img src="relational-nycflights.svg" width="60%" align="center" />
```

* `vuelos` se conecta con `aviones` a trav茅s de la variable  `codigo_cola`

* `vuelos` se conecta con `aerolineas` a trav茅s de la variable `codigo_carrier`.

* `vuelos` se conecta con `aeropuertos` de dos formas: a trav茅s de las variables `origen` y `destino`.

* `vuelos` se conecta con `clima` a trav茅s de las variables origen (es decir,la ubicaci贸n) m谩s `anio`, `mes`, `dia` y `hora`.

---
# Claves

* Las variables usadas para conectar cada par de variables se llaman **claves** (del ingl茅s _key_). 

* Una clave es una variable (o un conjunto de variables) que identifican de manera 煤nica una observaci贸n.

* En casos simples, una sola variable es suficiente para identificar una observaci贸n. 
**Ejemplo**: cada avi贸n est谩 identificado de forma 煤nica por su `codigo_cola`. 
* En otros casos, se pueden necesitar m煤ltiples variables. 
**Ejemplo**, para identificar una observaci贸n en `clima` se necesitan cinco variables:  `anio`, `mes`, `dia`, `hora` y `origen`.

---
# Claves

Existen diferentes tipos de claves:

* Una **clave primaria** identifica 煤nicamente una observaci贸n en su propia tabla.
  Por ejemplo, `codigo_cola` es una clave primaria, ya que identifica de manera 煤nica cada avi贸n en la tabla `aviones`.

* Una **clave for谩nea** identifica de manera 煤nica una observaci贸n en otra tabla.
  Por ejemplo, `vuelos$codigo_cola` es una clave for谩nea, ya que aparece en la tabla `vuelos`, y une cada vuelo con un 煤nico avi贸n.
  
* Una **clave subrogada**, es aquella que tiene como 煤nico requisito almacenar un valor num茅rico 煤nico para cada fila de la tabla, el cual es totalmente independiente a los datos de negocio.

**Importante:** Una variable puede ser clave primaria y clave for谩nea a la vez. Por ejemplo, `origen` es parte de la clave primaria de la tabla `clima` y tambi茅n una clave for谩nea de la tabla  `aeropuertos`, es decir, permite que el `clima` se relacione con un determinado aeropuerto.


  
---
class: inverse, center, middle
background-image: url("soga1.jpg")
background-size:cover
### JOINS

---
#Joins

#### Una uni贸n es una forma de conectar cada fila en x con cero, una o m谩s filas en y. 


 Familias de verbos para trabajar entre pares de tablas:

1. **__Uniones de transformaci贸n__** (del ingl茅s **_mutating joins_**), las cuales agregan nuevas variables a un *data frame* a partir de las observaciones coincidentes en otra tabla.

1. **__Uniones de filtro__** (del ingl茅s **_filtering joins_**), las cuales filtran observaciones en un *data frame* con base en si coinciden o no con una observaci贸n de otra tabla.

1. **__Operaciones de conjuntos__** (del ingl茅s **_set operations_**), las cuales tratan las observaciones como elementos de un conjunto.
---
#Joins
#### Sintaxis:

`tabla1` %>% 
**TIPO_DE_UNION** (`tabla2`, **by** = "key")

 donde *TIPO_DE_UNION* puede ser:

* inner_join

* left_join

* right_join

* full_join

* anti_join

* semi_join

**by** (seg煤n) le indica a dplyr qu茅 variable es la clave con la que se realizar谩 la uni贸n.

---
# Uniones de transformaci贸n 

La  **__uni贸n de transformaci贸n__** o **_mutating join_** permite combinar variables a partir de dos tablas. 

--
#### 1. Busca coincidencias de observaciones entre ambas tablas de acuerdo a su/s clave/s

--
#### 2. Luego, copia las variables de una tabla a la otra.

#### Principalmente, existen dos tipos de uni贸n:

.pull-left[
#### **uni贸n interior** 
-----------------------------
mantiene las observaciones que aparecen en ambas tablas.
]

.pull-right[
#### **uni贸n exterior** 
-----------------------------
mantiene las observaciones que aparecen en al menos una de las tablas
]
-------------------------------------------------

  .footnote[Mas informaci贸n en: https://dplyr.tidyverse.org/reference/join.html]

---
# Uniones de transformaci贸n

Las funciones de uni贸n, tal como `mutate()`, agregan variables hacia la derecha, por lo que si tienes muchas variables inicialmente, las nuevas variables no se imprimir谩n.

Por lo tanto, crearemos un conjunto de datos m谩s angosto para que sea m谩s f谩cil ver qu茅 es lo que est谩 ocurriendo: 
```{r vuelos2, echo=TRUE}
vuelos2 <- vuelos  %>%
  select (anio:dia, hora, origen, destino, codigo_cola, aerolinea) %>% head(7)
vuelos2
```

---

# Entendiendo las uniones de transformaci贸n


Una **uni贸n exterior** mantiene las observaciones que aparecen en al menos una de las tablas. Existen tres tipos de uniones exteriores:

* Una **uni贸n izquierda (left join)** mantiene todas las observaciones en x.

* Una **uni贸n derecha (right join)** mantiene todas las observaciones en y.

* Una **uni贸n completa (full join)** mantiene todas las observaciones en x e y.


---
# Representaci贸n gr谩fica de las uniones exteriores

```{r echo=FALSE, out.width = '40%', fig.align="center"}
knitr::include_graphics("join-outer.svg")
```

---

#  Uni贸n por izquierda 

Queremos incluir el nombre completo de la aerol铆nea en la tabla `vuelos2`.

####驴C贸mo lo hacemos? 
--


Combinamos los datos de `vuelos2` y `aerolineas` 
--

con un `left_join()` (*union_izquierda*):



```{r vuelos_aerolinea, echo=TRUE, message=FALSE, warning=FALSE, paged.print=TRUE}

union_tablas <-  vuelos2  %>%
     left_join (aerolineas, by = "aerolinea")#<<


  
```

---
#  Uni贸n por izquierda 

El resultado de unir `vuelos2` y `aerolineas` es la inclusi贸n de una variable adicional, `nombre` en la primera tabla. Por esta raz贸n llamamos uni贸n de transformaci贸n a este tipo de uni贸n.



```{r union_vuelos_aerolinea, echo=FALSE, message=FALSE, warning=FALSE, paged.print=TRUE}
union_tablas %>% head(10) #<<
  
```
---
class: inverse, center, top
background-image: url("banda1.jpg")
background-size:cover
# Dataset bandas 
---
# Tablas
.pull-left[
```{r message=FALSE, warning=FALSE}
dplyr::band_members
```
]

.pull-right[
```{r message=FALSE, warning=FALSE}
dplyr::band_instruments
```
]


```{r tabla_banda_instrumento, echo=FALSE, out.width = '100%', fig.align="right"}

knitr::include_graphics("tablas_banda_instrumento.png")
```


---
# Uni贸n interna o Inner Join


```{r banda_inner, echo=TRUE, message=FALSE, warning=FALSE}
band_members %>% inner_join(band_instruments)#<<
```
 
 En algunos casos, no es necesario especificar la clave por la cual se realizar谩 la uni贸n.

```{r inner_join_banda, echo=FALSE, out.width = '80%', fig.align="center"}
knitr::include_graphics("inner_join_banda_instrumento.png")
```




**Importante:** La propiedad m谩s importante de una uni贸n interior es que las filas no coincidentes no se incluyen en el resultado. 

---


# Uni贸n izquierda
```{r banda_left, echo=TRUE, warning=FALSE, message=FALSE}
band_members %>% left_join(band_instruments)#<<
```

```{r left_join_banda, echo=FALSE, out.width = '100%', fig.align="right"}
knitr::include_graphics("left_join_banda_instrumento.png")
```

---


# Uni贸n derecha 
```{r banda_right, echo=TRUE, warning=FALSE, message=FALSE}
band_members %>% right_join(band_instruments)#<<

```

```{r right_join_banda, echo=FALSE, out.width = '100%', fig.align="right"}
knitr::include_graphics("right_join_banda_instrumento.png")
```


---
# Full Join
```{r banda_full, echo=TRUE, message=FALSE, warning=FALSE}
band_members %>% full_join(band_instruments)#<<
```


```{r full_join_banda, echo=FALSE, out.width = '100%', fig.align="center"}
knitr::include_graphics("full_join_banda_instrumento.png")
```

---

# Diagramas de Venn:

Otra forma de ilustrar diferentes tipos de uniones es mediante un diagrama de Venn:

```{r, echo = FALSE, out.width = '100%', fig.align="center"}
knitr::include_graphics("join-venn.svg")

```

 * Son 煤tiles para recordar qu茅 uniones preservan las observaciones en qu茅 tabla 
 
 
 * Tienen una limitante importante: un diagrama de Venn no puede mostrar qu茅 ocurre con las claves que no identifican de manera 煤nica una observaci贸n.
 
---

# Uniones de filtrado 

Las **__Uniones de filtrado__** unen observaciones de la misma forma que las uniones de transformaci贸n pero afectan a las observaciones, no a las variables.Adem谩s, uniones de filtro no duplican filas como lo hacen las uniones de transformaci贸n.

####Tipos:

*  **semi_join:** mantiene todas las observaciones en x con coincidencias en y. Las semi uniones son 煤tiles para unir tablas resumen previamente filtradas con las filas originales.

*  **anti_join:** descarta todas las observaciones en x con coincidencias en y.
  
---
# Uniones de filtrado

### Semi Join
```{r banda_semi, echo=TRUE, message=FALSE, warning=FALSE}
band_members %>% semi_join(band_instruments) #<<
```

```{r semi_join_banda, echo=FALSE, out.width = '100%', fig.align="center"}
knitr::include_graphics("semi_join_banda_instrumento.png")
```
---
# Uniones de filtrado

### Anti Join 
```{r banda_anti, echo=TRUE, message=FALSE, warning=FALSE}
band_members %>% anti_join(band_instruments) #<<
```

```{r anti_join_banda, echo=FALSE, out.width = '100%', fig.align="center"}
knitr::include_graphics("anti_join_banda_instrumento.png")
```

---
# Utilidad de las uniones de filtrado
* Las **semi uniones** son 煤tiles para unir tablas resumen previamente filtradas con las filas originales.

```{r destinos_populare, message=FALSE, warning=FALSE, include=FALSE}
destinos_populares <- vuelos %>%
  count(destino, sort = TRUE) %>%
  head(7)

```

Buscamos cada vuelo que fue a alguno de los destinos m谩s populares: 

```{r semi_join_vuelos, echo=TRUE, message=FALSE, warning=FALSE}
vuelos %>%
  semi_join(destinos_populares)%>% #<<
  head(3)
```
---
# Utilidad de las uniones de filtrado

* Las **anti uniones** son 煤tiles para encontrar desajustes. Por ejemplo, al conectar `aviones` y `vuelos`, podr铆a ser interesante saber que existen muchos `vuelos` que no tienen coincidencias en `aviones`:

```{r vuelos_sin_aviones, echo=TRUE, message=FALSE, warning=FALSE}
vuelos %>%
  anti_join(aviones, by = "codigo_cola") %>%  #<<
  count(codigo_cola, sort = TRUE)%>% head(6)
```

---

# Operaciones de conjuntos

Tratan las observaciones como elementos de un conjunto.

* `intersect(x, y)`: devuelve las observaciones comunes en x e y.

* `union(x, y)`: devuelve las observaciones 煤nicas en x e y.

* `setdiff(x, y)`: devuelve las observaciones en x pero no en y.

**Ejemplo:**

```{r tribble, echo=TRUE, message=FALSE, warning=FALSE}
df1 <- tribble(
  ~x, ~y,
  1, 1,
  2, 1
)
df2 <- tribble(
  ~x, ~y,
  1, 1,
  1, 2
)
```
---

# Operaciones de conjuntos


Las cuatro posibilidades son:

```{r operaciones_conjuntos, echo=TRUE, message=FALSE, warning=FALSE}
intersect(df1, df2)
union(df1, df2)
```
---

# Operaciones de conjuntos

```{r operaciones_conjuntos2, echo=TRUE, message=FALSE, warning=FALSE}

setdiff(df1, df2)
setdiff(df2, df1)
```
---

class: inverse, center, middle
background-image: url("marvel.jpg")
background-size:cover
## Otros Ejemplos
### Dataset superh茅roes y editoriales 
---
## Tabla Superh茅roes
```{r superheroes2, echo=TRUE, message=FALSE, warning=FALSE}

superheroes <- tibble::tribble(
       ~name, ~alignment,  ~gender,          ~publisher,
   "Magneto",      "bad",   "male",            "Marvel",
     "Storm",     "good", "female",            "Marvel",
  "Mystique",      "bad", "female",            "Marvel",
    "Batman",     "good",   "male",                "DC",
     "Joker",      "bad",   "male",                "DC",
  "Catwoman",      "bad", "female",                "DC",
   "Hellboy",     "good",   "male", "Dark Horse Comics"
  )


```

```{r tabla_superheroes, echo=FALSE, out.width = '50%', message=FALSE, warning=FALSE, fig.align="center"}

knitr::kable(superheroes, format = 'html')
```

---
## Tabla editoriales

```{r editoriales, echo=TRUE, message=FALSE, warning=FALSE}

publishers <- tibble::tribble(
  ~publisher, ~yr_founded,
        "DC",       1934L,
    "Marvel",       1939L,
     "Image",       1992L
  )

```


```{r tabla_editoriales, echo=FALSE, message=FALSE, warning=FALSE, fig.align="center"}

knitr::kable(publishers, format = 'html')
```

---

## inner_join(superheroes, publishers)

```{r superheroes_inner, echo=TRUE, message=FALSE, warning=FALSE}
tabla_inner <- superheroes %>% inner_join (publishers)  #<< 
```

```{r tabla_inner, echo=FALSE, message=FALSE, warning=FALSE, fig.align="center"}

knitr::kable(tabla_inner, format = 'html')
```


---
## full_join(superheroes, publishers)

```{r superheroes_full, echo=TRUE, message=FALSE, warning=FALSE}
tabla_full <- superheroes %>% full_join (publishers)  #<<
```


```{r superheroes_full2, echo=FALSE, out.width = '70%', fig.align="center"}
knitr::kable(tabla_full, format = 'html')
```

---
## left_join(superheroes, publishers)

```{r superheroes_left, echo=TRUE, message=FALSE, warning=FALSE}
tabla_left <-superheroes %>% left_join (publishers)   #<<
```




```{r superheroes_left2, echo=FALSE, out.width = '75%',fig.align="center"}
knitr::kable(tabla_left, format = 'html')
```

---
## anti_join(superheroes, publishers)

```{r superheroes_anti, echo=TRUE, message=FALSE, warning=FALSE}
tabla_anti <- superheroes %>% anti_join (publishers)    #<<
```



```{r superheroes_anti2, echo=FALSE, out.width = '75%', fig.align="center"}
knitr::kable(tabla_anti, format = 'html')
```


---

## Fuentes:

* [R para Ciencia de datos](http://r4ds.had.co.nz/) 

* [Primers de Rstudio](https://rstudio.cloud/learn/primers/4.3)
 
* [Gu铆a de referencia](https://dplyr.tidyverse.org/reference/join.html)

* Slides de [Robust tools](https://github.com/gnab/remark/issues/142) de  [Danielle Navarro](https://twitter.com/djnavarro).

* [STAT 545 - Chapter 15](https://stat545.com/join-cheatsheet.html) de [Jenny Bryan](https://twitter.com/JennyBryan)

-------------------------------------------------

★ Las slides fueron creadas con el paquete de R [**xaringan**](https://github.com/yihui/xaringan), utilizando el css propio [summer_light](https://github.com/PatriLoto/datos_relaciones_con_dplyr/blob/master/summer_light.css).

★ Las im谩genes fueron tomadas de [Unplash](https://unplash.com).
